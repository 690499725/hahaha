import{_ as B,c as f,a as i,w as b,d as N,e as U,f as P,F as v,r as S,v as R,g as E,t as w,o as u,n as C}from"./index-Ck-Eidd7.js";const _={baseURL:"https://api.coze.cn/v3",botId:"7542771729836769320",apiKey:"pat_nfFPURqvNeN1P6lYR2wnHlc2eamrDrfOT2pMKji7wHHU7BBE7BwECN9poUwDkyGQ"},$=()=>"user_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),p=async(s,e=!0)=>{try{console.log("发送消息到Coze API:",s);const t=await fetch(`${_.baseURL}/chat`,{method:"POST",headers:{Authorization:`Bearer ${_.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({bot_id:_.botId,user_id:$(),stream:e,additional_messages:[{content_type:"text",role:"user",type:"question",content:s}],parameters:{}})});if(!t.ok){const r=await t.text();throw console.error("API响应错误:",t.status,r),new Error(`HTTP error! status: ${t.status}, message: ${r}`)}return e?t.body:await t.json()}catch(t){throw console.error("Coze API调用失败:",t),t}},O=async(s,e,t)=>{try{const r=s.getReader(),o=new TextDecoder;let a="",n="",g=!1,d=!1,M=0,T=0,D=0;for(console.log("开始处理流式响应...");;){const{done:A,value:I}=await r.read();if(A){console.log("流读取完成，总共处理了",M,"个数据块");break}M++;const k=o.decode(I);console.log(`数据块 ${M}:`,k);const x=k.split(`
`);for(const y of x)if(y.trim()!==""){if(y.startsWith("event:")){const m=y.slice(6).trim();console.log("收到事件类型:",m)}else if(y.startsWith("data:")){const m=y.slice(5).trim();if(m==="[DONE]"){console.log("收到[DONE]信号，流式响应结束"),console.log("最终推理内容:",a),console.log("最终回复内容:",n),n&&!d&&(console.log("显示最终内容"),e(n,"final"),d=!0),t&&t();return}try{const l=JSON.parse(m);if(console.log("解析的数据:",l),l.role==="assistant"&&l.type==="answer"){if(l.reasoning_content){const c=String(l.reasoning_content);if(c.startsWith(a)){const h=c.slice(a.length);a=c,h&&(g?(e(h,"append-reasoning"),T+=h.length):(e(h,"append-reasoning"),g=!0,T+=h.length))}else a+=c,e(c,"append-reasoning"),g=!0,T+=c.length}if(l.content){const c=String(l.content);if(c.startsWith(n)){const h=c.slice(n.length);n=c,h&&(d?(e(h,"append-final"),D+=h.length):(e(h,"append-final"),d=!0,D+=h.length))}else n+=c,d?e(c,"append-final"):(e(c,"append-final"),d=!0),D+=c.length}}l.type==="follow_up"&&l.content&&console.log("收到后续问题:",l.content)}catch(l){console.log("解析流数据失败:",l,"原始数据:",m)}}}}console.log("流处理完成，检查是否有未显示的内容"),!g&&a&&(console.log("流结束，显示推理内容:",a),e(`**思考过程：**
${a}`,"reasoning"),g=!0),!d&&n&&(console.log("流结束，显示最终内容:",n),e(n,"final"),d=!0),!a&&!n&&(console.log("没有收到任何内容"),e("抱歉，没有收到有效的回复。","error"))}catch(r){throw console.error("处理流式响应失败:",r),r}},z=async s=>{try{if(console.log("处理非流式响应:",s),typeof s=="string")return s;if(s instanceof Response){const e=await s.json();if(console.log("解析的响应数据:",e),e.choices&&e.choices[0]&&e.choices[0].message)return e.choices[0].message.content||"抱歉，我没有收到有效的回复。";if(e.role==="assistant"&&e.content)return e.content;if(Array.isArray(e)){const t=e.find(r=>r.role==="assistant");if(t&&t.content)return t.content}return"抱歉，我没有收到有效的回复。"}if(typeof s=="object"&&s!==null){if(console.log("响应对象:",s),s.choices&&s.choices[0]&&s.choices[0].message)return s.choices[0].message.content||"抱歉，我没有收到有效的回复。";if(s.role==="assistant"&&s.content)return s.content;if(Array.isArray(s)){const e=s.find(t=>t.role==="assistant");if(e&&e.content)return e.content}return"抱歉，我没有收到有效的回复。"}return"抱歉，我没有收到有效的回复。"}catch(e){throw console.error("处理响应失败:",e),e}},H={name:"AiView",data(){return{newMessage:"",isTyping:!1,useStream:!0,debugMode:!1,showThinking:!0,chatMessages:[{id:1,sender:"DeepSeek助手",content:"你好！我是DeepSeek智能助手，有什么可以帮助你的吗？",type:"message-answer"}],aiTools:[{id:1,title:"智能搜索",description:"基于知识库的精准搜索",icon:"fas fa-search"},{id:2,title:"智能答疑",description:"多类型问题解答",icon:"fas fa-question-circle"},{id:3,title:"写作辅助",description:"医疗文书写作助手",icon:"fas fa-pencil-alt"}]}},computed:{hasThinkingMessage(){return this.chatMessages.some(s=>s.type==="message-thinking"||s.type==="message-thinking-complete")}},methods:{async sendMessage(){if(this.newMessage.trim()===""||this.isTyping)return;const s=this.newMessage.trim(),e={id:Date.now(),sender:"用户",content:s,type:"message-question"};this.chatMessages.push(e),this.newMessage="",this.isTyping=!0;try{this.useStream?await this.handleStreamChat(s):await this.handleNormalChat(s)}catch(t){console.error("发送消息失败:",t),this.addErrorMessage("抱歉，发送消息时出现错误，请稍后重试。")}finally{this.isTyping=!1}this.$nextTick(()=>{this.scrollToBottom()})},async handleStreamChat(s){try{console.log("开始流式聊天，消息:",s);const e=await p(s,!0),t={id:Date.now()+1,sender:"DeepSeek助手",content:"",type:"message-thinking"},r={id:Date.now()+2,sender:"DeepSeek助手",content:"",type:"message-answer"};this.chatMessages.push(t),await O(e,(o,a)=>{if(console.log("收到内容:",o,"类型:",a),a==="append-reasoning")this.showThinking&&(t.content+=o,this.$forceUpdate());else if(a==="append-final")this.chatMessages.find(n=>n.id===r.id)||(r.content="",this.chatMessages.push(r)),r.content+=o,this.$forceUpdate(),t.content&&(t.type="message-thinking-complete",this.$forceUpdate());else if(a==="error"){const n={id:Date.now()+3,sender:"系统",content:o,type:"message-error"};this.chatMessages.push(n),this.$forceUpdate()}this.scrollToBottom()},()=>{if(console.log("思考过程完成"),t.content)t.type="message-thinking-complete",this.$forceUpdate();else{const o=this.chatMessages.findIndex(a=>a.id===t.id);o!==-1&&this.chatMessages.splice(o,1)}this.$forceUpdate()}),console.log("流式聊天完成")}catch(e){console.error("流式聊天失败:",e),this.addErrorMessage(`抱歉，AI响应出现错误：${e.message}`)}finally{this.isTyping=!1}},async handleNormalChat(s){try{console.log("开始普通聊天，消息:",s);const e=await p(s,!1);if(this.debugMode){console.log("原始响应对象:",e);const o={id:Date.now()+1,sender:"系统",content:`[DEBUG] 原始响应: ${JSON.stringify(e,null,2)}`,type:"message-info"};this.chatMessages.push(o)}const t=await z(e);console.log("普通聊天完成，内容:",t);const r={id:Date.now()+1,sender:"DeepSeek助手",content:t,type:"message-answer"};this.chatMessages.push(r)}catch(e){console.error("普通聊天失败:",e),this.addErrorMessage(`抱歉，AI响应出现错误：${e.message}`)}},addErrorMessage(s){const e={id:Date.now(),sender:"系统",content:s,type:"message-error"};this.chatMessages.push(e)},selectTool(s){console.log("选择工具:",s.title),this.newMessage=`我想使用${s.title}功能`},clearChat(){this.chatMessages=[{id:Date.now(),sender:"DeepSeek助手",content:"聊天记录已清空，有什么可以帮助你的吗？",type:"message-answer"}]},async testConnection(){try{this.isTyping=!0;const s={id:Date.now(),sender:"系统",content:"正在测试API连接...",type:"message-info"};this.chatMessages.push(s);const e=await p("测试",!1);console.log("API测试响应:",e);const t={id:Date.now()+1,sender:"系统",content:"API连接测试成功！",type:"message-success"};this.chatMessages.push(t)}catch(s){console.error("API连接测试失败:",s);const e={id:Date.now()+1,sender:"系统",content:`API连接测试失败：${s.message}`,type:"message-error"};this.chatMessages.push(e)}finally{this.isTyping=!1,this.scrollToBottom()}},async debugApiResponse(){try{this.isTyping=!0;const s={id:Date.now(),sender:"系统",content:"正在获取API原始响应...",type:"message-info"};this.chatMessages.push(s);const e=await p("你好",!0);console.log("流式响应对象:",e);const t={id:Date.now()+1,sender:"系统",content:`[DEBUG] 流式响应对象类型: ${typeof e}, 构造函数: ${e.constructor.name}`,type:"message-info"};this.chatMessages.push(t);const r=await p("你好",!1);console.log("非流式响应对象:",r);const o={id:Date.now()+1,sender:"系统",content:`[DEBUG] 非流式响应: ${JSON.stringify(r,null,2)}`,type:"message-info"};this.chatMessages.push(o)}catch(s){console.error("API调试失败:",s);const e={id:Date.now()+1,sender:"系统",content:`API调试失败：${s.message}`,type:"message-error"};this.chatMessages.push(e)}finally{this.isTyping=!1,this.scrollToBottom()}},async debugStreamRaw(){try{this.isTyping=!0;const s={id:Date.now(),sender:"系统",content:"正在获取原始流式数据...",type:"message-info"};this.chatMessages.push(s);const t=(await p("你好",!0)).getReader(),r=new TextDecoder;let o="";for(;;){const{done:a,value:n}=await t.read();if(a)break;const g=r.decode(n);o+=g;const d={id:Date.now()+1,sender:"系统",content:`[RAW] ${g}`,type:"message-info"};this.chatMessages.push(d),this.scrollToBottom()}console.log("完整原始数据:",o)}catch(s){console.error("原始流调试失败:",s);const e={id:Date.now()+1,sender:"系统",content:`原始流调试失败：${s.message}`,type:"message-error"};this.chatMessages.push(e)}finally{this.isTyping=!1,this.scrollToBottom()}},async simpleTest(){try{this.isTyping=!0;const s={id:Date.now(),sender:"系统",content:"开始简单测试...",type:"message-info"};this.chatMessages.push(s);const e=await p("你好",!1);console.log("简单测试响应:",e);const t={id:Date.now()+1,sender:"系统",content:`简单测试结果: ${JSON.stringify(e,null,2)}`,type:"message-info"};this.chatMessages.push(t)}catch(s){console.error("简单测试失败:",s);const e={id:Date.now()+1,sender:"系统",content:`简单测试失败：${s.message}`,type:"message-error"};this.chatMessages.push(e)}finally{this.isTyping=!1,this.scrollToBottom()}},scrollToBottom(){const s=document.querySelector(".chat-container");s&&(s.scrollTop=s.scrollHeight)}}},L={class:"ai-view"},F={class:"section"},V={class:"section-header"},W={class:"chat-controls"},j={class:"thinking-toggle"},q={class:"chat-container"},G=["innerHTML"],J={key:0,class:"message message-answer"},K={class:"chat-input"},Q=["disabled"],Y=["disabled"],Z={class:"section"},X={class:"grid-3"},ee=["onClick"],se={class:"tool-icon"},te={style:{"font-weight":"500"}},ne={style:{"font-size":"14px",color:"#7f8c8d"}};function oe(s,e,t,r,o,a){return u(),f("div",L,[i("div",F,[i("div",V,[e[6]||(e[6]=i("h3",{class:"section-title"},"智能助手",-1)),i("div",W,[i("label",j,[b(i("input",{type:"checkbox","onUpdate:modelValue":e[0]||(e[0]=n=>o.showThinking=n)},null,512),[[U,o.showThinking]]),e[5]||(e[5]=N(" 显示思考 ",-1))]),i("button",{class:"btn btn-outline",onClick:e[1]||(e[1]=(...n)=>a.clearChat&&a.clearChat(...n))},"清空聊天")])]),i("div",q,[(u(!0),f(v,null,S(o.chatMessages,n=>(u(),f("div",{class:C(["message",n.type]),key:n.id},[i("strong",null,w(n.sender)+":",1),i("span",{innerHTML:n.content},null,8,G)],2))),128)),o.isTyping&&!o.useStream?(u(),f("div",J,[...e[7]||(e[7]=[i("strong",null,"DeepSeek助手:",-1),i("span",{class:"typing-indicator"},[i("i",{class:"fas fa-circle"}),i("i",{class:"fas fa-circle"}),i("i",{class:"fas fa-circle"})],-1)])])):P("",!0)]),i("div",K,[b(i("input",{type:"text",placeholder:"输入您的问题...","onUpdate:modelValue":e[2]||(e[2]=n=>o.newMessage=n),onKeypress:e[3]||(e[3]=E((...n)=>a.sendMessage&&a.sendMessage(...n),["enter"])),disabled:o.isTyping},null,40,Q),[[R,o.newMessage]]),i("button",{class:"btn btn-primary",onClick:e[4]||(e[4]=(...n)=>a.sendMessage&&a.sendMessage(...n)),disabled:o.isTyping||!o.newMessage.trim()},w(o.isTyping?"发送中...":"发送"),9,Y)])]),i("div",Z,[e[8]||(e[8]=i("div",{class:"section-header"},[i("h3",{class:"section-title"},"助手工具")],-1)),i("div",X,[(u(!0),f(v,null,S(o.aiTools,n=>(u(),f("div",{class:"tool-card",key:n.id,onClick:g=>a.selectTool(n)},[i("div",se,[i("i",{class:C(n.icon)},null,2)]),i("div",null,[i("div",te,w(n.title),1),i("div",ne,w(n.description),1)])],8,ee))),128))])])])}const ae=B(H,[["render",oe],["__scopeId","data-v-d6e368e5"]]);export{ae as default};
